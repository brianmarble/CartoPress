<!doctype html>
<title>CartoPress Test</title>
<script src="http://openlayers.org/api/OpenLayers.js"></script>
<style>
	#map {
		width: 800px;
		height: 500px;
		border: solid black 1px;
		margin: auto;
	}
	#options {
		float: right;
	}
</style>
<script src="../CartoPress.js"></script>
<div id="options">
	<div>Choose Page Layout: <select id="layouts"></select></div>
	<div><input id="printButton" type="button" value="print"/></div>
</div>
<div id="map"></div>
<script>
	
	
	function BaseLayer(){
		return new OpenLayers.Layer.WMS(
			"BaseLayer",
			"http://mt.10000maps.com/dev/ms", 
			{
				map: 'landmaps/Base_Layers.map', 
				layers: 'BaseLayers_SimpleBase2'
			}
		);
	}
	
	function ForestLayer(){
		return new OpenLayers.Layer.WMS(
			"Layer2",
			"http://mt.10000maps.com/dev/ms",
			{
				map: 'landmaps/Worldwide_Land.map',
				layers: 'World_Forestland',
				transparent: 'true'
			}
		);
	}
	
	function Map(mapDivId){
		var lat = 4099508.5373339, lon = -10429774.028535;
		var baseLayer = new BaseLayer();
		var forestLayer = new ForestLayer();
		var map = new OpenLayers.Map(
			mapDivId,
			{
				projection: "EPSG:900913"
			}
		);
		map.addLayers([baseLayer, forestLayer]);
		map.setBaseLayer(baseLayer);
		map.setCenter(new OpenLayers.LonLat(lon,lat), 4);
		
		return map;
	}

	var map = new Map('map');
	/*var spa = new OpenLayers.Control.ModifyFeature(
		map.spa,
		{
			mode:	OpenLayers.Control.ModifyFeature.RESIZE |
					OpenLayers.Control.ModifyFeature.DRAG
		}
	);
	
	*/
	var c = new CartoPress.SelectPrintArea();
	map.addControl(c);
	c.activate();
	/*
	var spa = new CartoPress.SelectPrintArea();
	map.addControl(spa);
	spa.activate();
	*/
	/*var c = new OpenLayers.Control.DrawFeature(
		map.vectorLayer, 
		OpenLayers.Handler.RegularPolygon, 
		{
			displayClass: 'olControlDrawFeaturePolygon',
			handlerOptions: {
				citeCompliant: false,
				sides: 4,
				snapAngle: 45
			}
		}
	);
	
	map.addControl(c);
	c.activate();*/
	

	
	
	var cp = new CartoPress();
	
	cp.getAvailableFormats(function(formats){
		var selectLayoutDiv = document.getElementById('layouts'),
			optionEl;
		for(var i = 0; i < formats.length; i++){
			optionEl = document.createElement('option');
			optionEl.textContent = formats[i].name;
			optionEl.value = formats[i].name;
			optionEl.dataset.ratio = formats[i].ratio;
			selectLayoutDiv.appendChild(optionEl);
		}
		c.setRatio(formats[0].ratio);
		return;
		var f = vlayer.features[0];
		var b = f.geometry.getBounds();
		var name = "new_"+(new Date().getTime());
		cp.createPdf(map,b,formats[0],name,function(url){
			console.log(url);
			window.pdfurl = url;
			//location.assign(cp.url+'/pdfs/'+name+'.pdf');
		});
	})
	
	document.getElementById('layouts').addEventListener('change',function(){
		var val = document.getElementById('layouts').selectedOptions[0].dataset.ratio;
		c.setRatio(+val);
	});
	document.getElementById('printButton').addEventListener('click',print);
	
	function print(){
		var b = c.getBounds();
		var layout = document.getElementById('layouts').value;
		var name = "new_"+(new Date().getTime());
		cp.createPdf(map,b,layout,name,function(url){
			console.log(url);
			//window.pdfurl = url;
			location.assign(cp.url+'/pdfs/'+name+'.pdf');
		});
	}

</script>
